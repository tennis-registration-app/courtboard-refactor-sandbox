<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tennis — Mobile</title>
  <style>
    html,body{height:100%;margin:0;background:#0b0b0b;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .host{position:relative;width:100%;height:100dvh;overflow:hidden}
    iframe{width:100%;height:100%;border:0;background:#111}
    .overlay{position:absolute;inset:0;display:none;background:rgba(0,0,0,.45);backdrop-filter:blur(6px)}
    .overlay.show{display:block}
  </style>
  
  <!-- Shared modules -->
  <script src="shared/config.js"></script>
  <script src="shared/storage.js"></script>
  <script src="shared/events.js"></script>
  <script src="shared/datastore.js"></script>
  <script src="domain/time.js"></script>
  <script src="domain/availability.js"></script>
  <script src="domain/blocks.js"></script>
  <script src="domain/wetCourts.js"></script>
  <script src="domain/waitlist.js"></script>
  <script src="domain/selfTest.js"></script>
  
  <!-- Health check script -->
  <script>
    console.log('🏥 Mobile Shell: Running health check...');
    
    function checkModuleAvailability() {
      const modules = [
        'window.Tennis.Config',
        'window.Tennis.Storage',
        'window.Tennis.Events',
        'window.Tennis.DataStore',
        'window.Tennis.Domain.Time',
        'window.Tennis.Domain.Availability',
        'window.Tennis.Domain.Blocks',
        'window.Tennis.Domain.WetCourts',
        'window.Tennis.Domain.Waitlist',
        'window.Tennis.selfTest'
      ];
      
      const missing = modules.filter(mod => {
        try {
          return !eval(mod);
        } catch {
          return true;
        }
      });
      
      if (missing.length === 0) {
        console.log('✅ All modules loaded successfully');
        if (window.Tennis.selfTest) {
          const results = window.Tennis.selfTest.runAll();
          console.log(`🧪 Self-tests completed: ${results.passed}/${results.total} passed (${Math.round(results.successRate * 100)}%)`);
        }
      } else {
        console.warn('⚠️ Missing modules:', missing);
      }
    }
    
    // Check iframes when they load
    (function () {
      function getRegFrame() {
        return document.getElementById('iframeReg') || document.getElementById('iframeRegistration');
      }
      function getBoardFrame() {
        return document.getElementById('iframeBoard');
      }
      function checkFrame(frameEl) {
        const f = frameEl;
        if (!f || !f.contentWindow) return { ok:false, reason: 'iframe missing' };
        const w = f.contentWindow;
        const T = w.Tennis || {};
        const D = (T.Domain || {});
        return {
          ok: !!(T.Config && T.Storage && T.Events && T.DataStore && (D.time || D.Time) && (D.availability || D.Availability)),
          keys: Object.keys(D || {})
        };
      }
      function logHealth() {
        const reg = checkFrame(getRegFrame());
        const brd = checkFrame(getBoardFrame());
        console.log('[Mobile Health] Registration:', reg);
        console.log('[Mobile Health] Board:', brd);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', logHealth);
      } else {
        logHealth();
      }
      (window.Tennis && window.Tennis.Events && window.Tennis.Events.onDom) &&
        window.Tennis.Events.onDom('tennisDataUpdate', logHealth);
    })();
    
    // Run checks
    document.addEventListener('DOMContentLoaded', () => {
      checkModuleAvailability();
    });
  </script>
</head>
<body>
  <main class="host">
    <iframe id="iframeBoard" src="CourtBoard.html" title="Court Board"></iframe>
    <div id="regOverlay" class="overlay" aria-hidden="true">
      <div style="position:absolute;top:10px;right:10px;z-index:1000;">
        <button onclick="hideReg()" style="background:rgba(0,0,0,0.8);color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;">✕</button>
      </div>
      <iframe id="iframeReg" src="Registration.html" title="Registration"></iframe>
    </div>
  </main>

  <script>
    const overlay   = document.getElementById('regOverlay');
    const iframeReg = document.getElementById('iframeReg');
    const iframeBoard = document.getElementById('iframeBoard');

    function showReg(courtNumber){
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
      // ask Registration to start (no reload)
      try { iframeReg.contentWindow.postMessage({ type:'register', courtNumber:Number(courtNumber) }, '*'); } catch {}
    }
    function hideReg(){
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
    }

    // Receive events from child iframes
    window.addEventListener('message', e => {
      const d = e?.data; if (!d) return;
      console.log('Mobile Shell: Received message:', d);
      
      if (d.type === 'register') {
        console.log('Mobile Shell: Opening registration for court', d.courtNumber);
        showReg(d.courtNumber);
      } else if (d.type === 'registration:success') {
        console.log('Mobile Shell: Registration success for court', d.courtNumber, '- closing overlay in 5 seconds');
        // Show success screen for 5 seconds before closing
        setTimeout(() => {
          hideReg();
          console.log('Mobile Shell: Closing overlay after 5 second delay');
        }, 5000);
        // visual confirmation on the board immediately
        try { iframeBoard.contentWindow.postMessage({ type:'highlight', courtNumber: Number(d.courtNumber) }, '*'); } catch {}
      }
    });
  </script>
</body>
</html>